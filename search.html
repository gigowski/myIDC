<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Open Food Facts – Search + Barcode</title>

  <!-- Font Awesome (free CDN) -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

  <style>
    body{
      font-family:Arial,Helvetica,sans-serif;
      max-width:900px;margin:30px auto;padding:20px;
      background:#f9f9f9;color:#333;
    }
    h1{text-align:center;color:#2c3e50;margin-bottom:8px;}
    .search-bar{
      display:flex;align-items:center;
      background:#fff;border:2px solid #ddd;border-radius:12px;
      overflow:hidden;
      box-shadow:0 2px 6px rgba(0,0,0,.1);
    }
    .search-bar input{
      flex:1;padding:14px 16px;
      border:none;font-size:16px;outline:none;
    }
    .search-bar button{
      background:transparent;border:none;
      padding:0 14px;font-size:1.2rem;color:#555;
      cursor:pointer;transition:color .2s;
    }
    .search-bar button:hover{color:#3498db;}
    .results{margin-top:20px;}
    .food-item{
      background:#fff;padding:15px;margin-bottom:12px;
      border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,.1);
      line-height:1.6;
    }
    .serving,.carbs{font-size:.85em;color:#7f8c8d;font-style:italic;}
    .loading,.error{text-align:center;margin:20px 0;font-style:italic;}
    .loading{color:#3498db;}
    .error{color:#e74c3c;}
  </style>
</head>
<body>

  <h1>Open Food Facts Search</h1>

  <div class="search-bar">
    <input type="text" id="searchInput"
           placeholder="Food name or barcode…" />
    <button id="searchBtn" title="Search">
      <i class="fas fa-search"></i>
    </button>
    <button id="scanBtn" title="Scan barcode">
      <i class="fas fa-barcode"></i>
    </button>
  </div>

  <div id="results" class="results"></div>

  <!-- Barcode scanner library (QuaggaJS) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

  <script>
    const inputEl   = document.getElementById('searchInput');
    const resultsEl = document.getElementById('results');

    /* ---------- SEARCH BY TEXT ---------- */
    const doSearch = async (query) => {
      if (!query) { resultsEl.innerHTML='<p class="error">Enter something.</p>'; return; }
      resultsEl.innerHTML='<p class="loading">Searching…</p>';

      try{
        const url = `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(query)}&search_simple=1&action=process&json=1&page_size=20`;
        const resp = await fetch(url);
        const data = await resp.json();

        if (!data.products?.length){
          resultsEl.innerHTML='<p class="error">No results.</p>'; return;
        }

        let html = '';
        for(const p of data.products.slice(0,10)){
          const name   = p.product_name || p.generic_name || '???';
          const brand  = p.brands?.split(',')[0].trim() || '';
          const full   = brand ? `${brand} ${name}` : name;

          // ---- serving ----
          let serving = p.serving_size || p.nutriments?.serving_size || '100g';
          if(p.quantity && !p.quantity.includes(serving)){
            serving = `${p.quantity.trim()} (${serving})`;
          }else if(p.quantity){ serving = p.quantity.trim(); }

          // ---- carbs per serving ----
          let carbs = 'N/A';
          if(p.nutriments?.carbohydrates_serving){
            carbs = `${p.nutriments.carbohydrates_serving.toFixed(1)}g`;
          }else if(p.nutriments?.carbohydrates_100g && serving.includes('g')){
            const g = parseFloat(serving);
            if(!isNaN(g)){
              carbs = `${(p.nutriments.carbohydrates_100g * g / 100).toFixed(1)}g`;
            }
          }

          html += `
            <div class="food-item">
              <strong>${esc(full)}</strong><br>
              <span class="serving">Serving: ${esc(serving)}</span><br>
              <span class="carbs">Total Carbs: ${carbs}</span>
            </div>`;
        }
        resultsEl.innerHTML = html;
      }catch(e){
        resultsEl.innerHTML='<p class="error">Network error.</p>';
        console.error(e);
      }
    };

    document.getElementById('searchBtn').onclick = () => doSearch(inputEl.value.trim());
    inputEl.addEventListener('keypress', e=>{ if(e.key==='Enter') doSearch(inputEl.value.trim()); });

    /* ---------- BARCODE SCANNER ---------- */
    const scanBtn = document.getElementById('scanBtn');
    let scannerActive = false;

    scanBtn.onclick = () => {
      if(scannerActive){ Quagga.stop(); return; }
      scannerActive = true;
      scanBtn.innerHTML = '<i class="fas fa-stop"></i>'; // stop icon while scanning

      // create a temporary video container
      const videoBox = document.createElement('div');
      videoBox.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:9999;display:flex;align-items:center;justify-content:center;';
      videoBox.innerHTML = `<div id="scanner" style="width:90%;max-width:500px;"></div><p style="position:absolute;bottom:20px;color:#fff;">Align barcode inside the frame</p>`;
      document.body.appendChild(videoBox);

      Quagga.init({
        inputStream: { name:"Live", type:"LiveStream", target: '#scanner', constraints:{ facingMode:"environment" } },
        decoder: { readers:["ean_reader","ean_8_reader","upc_reader","code_128_reader"] },
        locate: true
      }, err => {
        if(err){ console.error(err); alert('Camera error – try again'); closeScanner(); return; }
        Quagga.start();
      });

      Quagga.onDetected(data => {
        const code = data.codeResult.code;
        closeScanner();
        inputEl.value = code;
        doSearch(code);
      });

      const closeScanner = () => {
        Quagga.stop();
        document.body.removeChild(videoBox);
        scannerActive = false;
        scanBtn.innerHTML = '<i class="fas fa-barcode"></i>';
      };
    };

    // tiny HTML escaper
    const esc = s => s ? s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) : '';
  </script>
</body>
</html>